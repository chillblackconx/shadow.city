<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Shadow City</title>
  <style>
    body { margin:0; background:#0d0d0d; color:white; font-family:Arial; text-align:center; }
    canvas { background:#1a1a1a; display:block; margin:20px auto; border:2px solid #444; }
    h1 { margin:10px; }
    .menu { display:flex; justify-content:center; gap:10px; margin:10px; flex-wrap:wrap; }
    button { padding:8px 12px; border:none; border-radius:6px; background:#333; color:white; cursor:pointer; }
    button.active { background:#f39c12; }
    #stats { margin:10px; font-size:18px; }
  </style>
</head>
<body>
<h1>🌞 Shadow City 🌑</h1>
<div id="stats">💰 Argent: 100 | 👥 Population: 0 | ⚡: OFF | 💧: OFF</div>
<p>[Clique = placer/détruire] - [Espace = switch monde] - [R = rotation]</p>

<div class="menu">
  <button id="houseBtn" class="active">Maison (50$)</button>
  <button id="farmBtn">Ferme (100$)</button>
  <button id="factoryBtn">Usine (200$)</button>
  <button id="shopBtn">Magasin (150$)</button>
  <button id="roadBtn">Route (5$)</button>
  <button id="powerBtn">Centrale (1000$)</button>
  <button id="filterBtn">Filtrage eau (800$)</button>
  <button id="bulldozeBtn">🗑️ Détruire</button>
  <button onclick="window.location.href='sous-sol.html'">🔽 Aller au sous-sol</button>
</div>

<canvas id="gameCanvas" width="600" height="600"></canvas>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

const gridSize = 12, cellSize = 50;
let selectedBuilding = "house", rotation=0;

// État principal
let state = {
  money: 100,
  population: 0,
  grid: Array.from({length:gridSize},()=>Array(gridSize).fill(null))
};

// Charger sauvegarde
if(localStorage.getItem("shadowCitySave")){
  state = JSON.parse(localStorage.getItem("shadowCitySave"));
}

// Charger réseau du sous-sol
let subState = { grid:Array.from({length:gridSize},()=>Array(gridSize).fill(null)) };
if(localStorage.getItem("shadowCitySub")){
  subState = JSON.parse(localStorage.getItem("shadowCitySub"));
}

function saveGame(){
  localStorage.setItem("shadowCitySave", JSON.stringify(state));
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(let y=0;y<gridSize;y++){
    for(let x=0;x<gridSize;x++){
      ctx.strokeStyle="#333"; ctx.strokeRect(x*cellSize,y*cellSize,cellSize,cellSize);
      let b=state.grid[y][x];
      if(b) drawBuilding(x,y,b);
    }
  }
  const powerOn = checkPower(), waterOn = checkWater();
  document.getElementById("stats").textContent = `💰 Argent: ${state.money} | 👥 Population: ${state.population} | ⚡: ${powerOn?"ON":"OFF"} | 💧: ${waterOn?"ON":"OFF"}`;
}

function drawBuilding(x,y,b){
  let px=x*cellSize, py=y*cellSize;
  ctx.save(); ctx.translate(px+25,py+25); ctx.rotate(b.rotation*Math.PI/2); ctx.translate(-25,-25);
  if(b.type==="house"){ ctx.fillStyle="#ffcc66"; ctx.fillRect(10,20,30,25); ctx.fillStyle="#cc3333"; ctx.beginPath(); ctx.moveTo(10,20); ctx.lineTo(25,5); ctx.lineTo(40,20); ctx.closePath(); ctx.fill();}
  if(b.type==="farm"){ ctx.fillStyle="#2ecc71"; ctx.fillRect(5,5,40,40);}
  if(b.type==="factory"){ ctx.fillStyle="#bdc3c7"; ctx.fillRect(5,20,40,25); ctx.fillStyle="#444"; ctx.fillRect(15,5,10,15);}
  if(b.type==="shop"){ ctx.fillStyle="#3498db"; ctx.fillRect(5,5,40,40); ctx.fillStyle="white"; ctx.fillText("S",20,30);}
  if(b.type==="road"){ ctx.fillStyle="#555"; ctx.fillRect(0,20,50,10);}
  if(b.type==="power"){ ctx.fillStyle="orange"; ctx.fillRect(5,5,40,40); ctx.fillStyle="black"; ctx.fillText("⚡",15,30);}
  if(b.type==="filter"){ ctx.fillStyle="#2980b9"; ctx.fillRect(5,5,40,40); ctx.fillStyle="white"; ctx.fillText("💧",15,30);}
  ctx.restore();
}

// Vérifier route adjacente
function hasAdjacentRoad(x,y){
  const dirs=[[1,0],[-1,0],[0,1],[0,-1]];
  for(let d of dirs){
    let nx=x+d[0], ny=y+d[1];
    if(nx>=0&&ny>=0&&nx<gridSize&&ny<gridSize){
      let b=state.grid[ny][nx];
      if(b && b.type==="road") return true;
    }
  }
  return false;
}

// Vérifier réseau électricité
function checkPower(){
  for(let y=0;y<gridSize;y++){
    for(let x=0;x<gridSize;x++){
      if(subState.grid[y][x] && subState.grid[y][x].type==="cable") return true;
    }
  }
  return false;
}

// Vérifier réseau eau
function checkWater(){
  for(let y=0;y<gridSize;y++){
    for(let x=0;x<gridSize;x++){
      if(subState.grid[y][x] && subState.grid[y][x].type==="pipe") return true;
    }
  }
  return false;
}

// Clic souris
canvas.addEventListener("click",(e)=>{
  const rect=canvas.getBoundingClientRect();
  const x=Math.floor((e.clientX-rect.left)/cellSize);
  const y=Math.floor((e.clientY-rect.top)/cellSize);
  if(x>=0&&y>=0&&x<gridSize&&y<gridSize){
    let existing = state.grid[y][x];
    if(selectedBuilding==="bulldoze"){
      if(existing){
        state.money+=Math.floor((existing.price||0)/2);
        if(existing.type==="house") state.population-=5;
        state.grid[y][x]=null;
      }
    } else {
      const costs={house:50,farm:100,factory:200,shop:150,road:5,power:1000,filter:800};
      if(!existing && state.money >= costs[selectedBuilding]){
        state.grid[y][x]={type:selectedBuilding, rotation:rotation, price:costs[selectedBuilding]};
        state.money -= costs[selectedBuilding];
        if(selectedBuilding==="house") state.population+=5;
      }
    }
  }
  draw(); saveGame();
});

// Rotation + switch monde
document.addEventListener("keydown",(e)=>{if(e.code==="KeyR") rotation=(rotation+1)%4;});

// Menu boutons
document.querySelectorAll(".menu button").forEach(btn=>{
  if(btn.id.endsWith("Btn")){
    btn.addEventListener("click",()=>{
      document.querySelectorAll(".menu button").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      selectedBuilding=btn.id.replace("Btn","");
    });
  }
});

// Revenus réguliers
setInterval(()=>{
  const powerOn=checkPower(), waterOn=checkWater();
  let income=0;
  for(let y=0;y<gridSize;y++){
    for(let x=0;x<gridSize;x++){
      const b=state.grid[y][x];
      if(!b) continue;
      if(b.type==="house" && powerOn && waterOn) income+=2;
      if(b.type==="farm" && waterOn) income+=20;
      if(b.type==="factory" && powerOn && hasAdjacentRoad(x,y)) income+=50;
      if(b.type==="shop" && powerOn && hasAdjacentRoad(x,y)){
        const r=Math.random();
        if(r<0.05) income+=90;
        else if(r<0.2) income+=0;
        else income+=30;
      }
    }
  }
  state.money+=income;
  draw(); saveGame();
},5000);

draw();
</script>
</body>
</html>
